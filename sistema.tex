\chapter{Sistema de resolución de conflictos}
En este capítulo se propondrá el marco teórico y el esquema aplicativo del sistema de resolución de conflictos a utilizar en el marco de MAPC.

\section{Información necesaria}
Después de estudiar el flujo de información y el contenido de la base de conocimiento de cada uno de nuestros agentes, sabemos que en cada turno un agente conoce su conjunto completo de creencias, deseos, y tiene al menos una intención persistente y bien determinada, al igual que \textit{al menos} una acción a realizar a futuro. Recordemos, además, que gracias al Servidor de Percepciones cada agente tiene una visión unificada del mundo y conoce los roles, posiciones y características físicas de sus compañeros de equipo.

Consideremos el agregado a la arquitectura mostrado; luego de esta nueva fase de comunicación, todos los agentes conocen la decisión tomada por sus compañeros de equipo, incluyendo tanto la intención más fuerte como la acción a realizar por cada uno de ellos.  Toda esta información, en conjunto, puede ser utilizada con el fin de re-analizar concretamente cuán potencialmente beneficiosa, peligrosa o perjudicial es la acción a realizar por el agente, y reconsiderar al respecto.

\section{Propuesta de coordinación}

Mostraremos ahora la primer posibilidad de coordinación propuesta; este sistema fue propuesto para ser utilizado durante la competencia MAPC 2011, y si bien no pudo ser presentado por falta de tiempo, existen algunas versiones en estado \textit{beta} ya implementadas.

\subsection{Prioridad de las intenciones}
Dado que el sistema provee suficiente flexibilidad como para permitir definir
distintas estrategias de resolución de acuerdo a la táctica utilizada en la fase
actual del juego, el primer paso es escribir un conjunto de \textbf{órdenes de prioridad para las intenciones} acorde a dichas fases.
Por ejemplo, si los agentes consideraran tres fases diferentes del juego (exploración, conquista de zonas y defensa del terreno), se debe contar con tres órdenes de prioridad, uno para cada respectiva fase. Esto resulta en que el sistema de resolución propuesto permita modificar el comportamiento de los agentes de manera dinámica según el estado
de la simulación, en lugar de resolver los potenciales conflictos siempre del mismo modo. Los órdenes de prioridad escritos indicarán la importancia de las posibles intenciones de los agentes en una fase determinada del juego.
A modo de ejemplo, durante los primeros veinte turnos de la simulación, el orden de prioridad puede ser definido de manera tal que se priorice la exploración del mapa a la expansión de zonas; de esta manera, los agentes pueden obtener mayor información del escenario para elaborar mejores planes a la hora de conquistar zonas del mapa. Durante los siguientes turnos, los agentes pueden utilizar otro orden de prioridad que favorezca la expansión de zonas; y por último, sobre el final del juego, si el equipo tiene ventaja en el puntaje respecto a los rivales, los agentes podrían optar políticas más defensivas utilizando un orden de prioridad que favorezca la conservación de puntos, en lugar de aventurarse a expandirse a las zonas aún no conquistadas del mapa.

Una vez que contamos con los órdenes de prioridad, el agente utilizará todo el
conocimiento de las características físicas y las intenciones y acciones
inminentes de sus compañeros para re-evaluar la propia. Es importante mencionar
que, en este esquema de coordinación, cuando un agente decide que realizar la
acción que había elegido deja de ser conveniente, pasa a actuar de manera
\textit{segura}, en el sentido de que realiza acciones que garantizan (o al
menos, maximizan las chances de) que no haya conflictos con otros agentes o
riesgo de pérdida de puntos. Se detallarán las potenciales acciones a realizar en \textit{modo seguro} en la sección siguiente, y más adelante analizaremos alternativas de acción que puedan dar aún más rédito.

\subsection{Clasificación de conflictos}
Existen diferentes tipos de conflicto que los agentes pueden encontrar al
momento de reconsiderar su decisión respecto a la manera de actuar.

Resulta natural pensar, por ejemplo, que si dos o más agentes van a realizar una acción persiguiendo
una intención idéntica (y que dicha acción/intención deba ser
realizada una única vez), entonces es un malgasto de recursos (energía) que
todos ellos la realicen. Un ejemplo de este caso ocurre cuando dos agentes
cualesquiera tienen como intención survey($X_{i}$) o cuando dos exploradores
tienen como intención probear($X_{i}$) para el mismo \textit{i}, o cuando dos inspectores tienen como
intención inspect estando en el mismo nodo. En cualquiera de estos
casos, resulta evidente que sólo uno de los agentes debería llevar a cabo la
acción. El criterio específico para decidir cuál de ellos la realiza puede ser
definido de muchas maneras; el propuesto para la competencia fue dejar que el
agente que pudiera efectivizar la intención en menor cantidad de turnos
realizara la acción, y en caso de empate, dejar que el que tuviera más energía
fuera el ganador. Si ambas condiciones resultaran en empate, el ganador se
determina por orden lexicográfico, pasando todos los perdedores a actuar en \textit{modo seguro}.

Sin embargo, no todos los casos en los que dos o más agentes tengan exactamente
la misma intención resultan conflictivos: por ejemplo, dos saboteadores pueden
querer atacar de manera simultánea a un mismo enemigo. Esta situación da lugar a
la clasificación de todas las intenciones en dos tipos: \textit{cooperativas} y
\textit{excluyentes}.

Por último, existen conflictos más complejos para su detección y
resolución; por ejemplo, supongamos una zona dominada por el equipo, con dos agentes delimitando una de las fronteras en dos nodos consecutivos; si ambos agentes decidieran intentar expandir la zona para aumentar el puntaje ganado en cada turno al mismo tiempo, y se movieran en direcciones opuestas separándose de manera que queden \textit{dos} nodos vacíos en medio de ellos, el control de la zona se perdería, resultando en una gran pérdida de puntos. En un caso como éste, aplicando el sistema de coordinación, sólo uno de los agentes expandiría la zona, mientras que el otro actuaría en \textit{modo seguro}, resultando en que el equipo logra obtener una zona mayor que la que antes tenía, y sin riesgo de que ésta se rompa debido a la des-coordinación de los agentes. Por otro lado, a lo largo del turno siguiente, los agentes volverían a considerar expandir la zona, logrando así un avance posiblemente más lento en la conquista del mapa, pero indudablemente más seguro y efectivo.
%que dos agentes decidan moverse para expandir una zona ya dominada, y que el movimiento sincronizado resulte en la pérdida de la zona.

A continuación, propondremos cómo detectar y resolver todos estos conflictos.

\subsection{Detección de conflictos}

Una vez finalizada la segunda fase de comunicación, cada agente considera las
intenciones y acciones a realizar de los demás miembros del equipo en busca de
potenciales conflictos.

\subsubsection{Intenciones excluyentes simultáneas}
El primer paso es verificar si existen agentes en el equipo con intenciones \textit{excluyentes} que coincidan.
Si ese es el caso, se evalúa cuál de dichos agentes se encuentra en mejor estado para efectivizar
la intención (de acuerdo a, como se mencionó antes, la cantidad de turnos
que necesitará para efectivizarla, seguido en caso de empate por la energía de cada uno de ellos, y por último según el orden lexicográfico de sus nombres), y en los siguientes pasos del algoritmo se asume que todos los demás actuarán en \textit{modo seguro}. En caso de que el propio agente sea uno de los que tienen una intención excluyente, y detecte que existe otro miembro del equipo en mejores condiciones de efectivizarla, el agente pasa a actuar en \textit{modo seguro} y el algoritmo finaliza.

Por razones de optimización, en las versiones beta ya implementadas del sistema los agentes proveen en la última fase de comunicación la cantidad de turnos que suponen necesitar para efectivizar la intención (considerando siempre el mejor caso; es decir, que no ocurran condiciones de corte, ataques enemigos, o cambios de plan repentinos).

Este paso del algoritmo es prácticamente trivial, pero elimina muchas acciones redudantes, ahorra mucho tiempo de cómputo, y resulta también en un ahorro considerable de energía para los agentes y en un mejor desempeño del equipo en general.% mencionar que en versiones futuras se puede incluir TODO EL PLAN de los agentes (es decir, todos los pasos que van a seguir), para posiblemente argumentar sobre la mejor decisión con eso (?)

\subsubsection{Ordenamiento}
El siguiente paso consiste en ordenar a los agentes de acuerdo al orden de prioridad establecido a las intenciones para la fase del juego actual. La intención que cada agente persigue será utilizada para posicionarlo de manera acorde en este ordenamiento: dado que en la última fase del algoritmo cada agente únicamente analizará las acciones que se correspondan con una intención mejor priorizada que la propia, los agentes con prioridades más altas en sus intenciones tienen menos chance de encontrar un conflicto que los haga pasar a actuar en modo seguro, mientras que los que tienen intenciones menos prioritarias deberán comprobar que su acción no interfiera con una cantidad mayor de compañeros.

\subsubsection{Coloreo hipotético del mapa}
A continuación, en caso de que la fase de intenciones excluyentes no haya detectado ningún conflicto, se pasa a la etapa más compleja del algoritmo; dado que cada agente que provoque cambios en su posición en el mapa puede afectar el control de las zonas dominadas, el sistema realiza una simulación progresiva de los puntos que el equipo puede obtener de acuerdo a las nuevas hipotéticas posiciones de cada agente. Esta simulación es llamada \textit{progresiva} porque se realiza corriendo una instancia del algoritmo de coloreo por cada nueva posición hipotética de los agentes.

El algoritmo de coloreo trabaja recibiendo una lista de posiciones de los agentes en el mapa, y retorna el puntaje correspondiente a las zonas formadas por los agentes. Este algoritmo fue utilizado durante la competencia para que cada agente encuentre la posición más favorable en la que podría ubicarse, pero sin la chance de analizar el comportamiento de los demás agentes; en este caso, lo utilizaremos conociendo ahora las intenciones y acciones inminentes del resto de los compañeros de equipo, para simular de acuerdo al orden de prioridad el estado del mapa, y decidir si este nuevo estado es más o menos favorable según cada uno de los movimientos de los agentes.

Recordando que los miembros del equipo se encuentran ordenados de acuerdo a la prioridad de sus intenciones, el sistema comienza calculando el puntaje según las posiciones \textbf{originales} de todos los agentes \textbf{excepto el que tiene la mayor prioridad para moverse}; dicho puntaje es tomado como \textit{puntaje base}, y a partir de éste se vuelve a correr el algoritmo de coloreo con la nueva posición hipotética del segundo agente mejor priorizado; los dos puntajes se comparan, % mayor o igual? definir threshold?
y si el nuevo es mayor o igual, pasa a ser el puntaje de referencia.

Los cálculos se repiten colocando uno a uno de los agentes en su nueva posición hipotética. Si la acción mejora o mantiene igual el puntaje obtenido respecto al puntaje \textit{base}, entonces se considera que esta acción no resulta perjudicial para el equipo, y por lo tanto, que el agente la efectivizará; el nuevo puntaje pasa a ser el puntaje de referencia, y se continúa simulando con el siguiente agente mejor priorizado. En caso contrario, se interpreta que la acción a tomar por el agente conflictivo es peligrosa, y se asume que dicho agente detectará su conflicto y pasará a actuar en \textit{modo seguro}; por lo tanto, la siguiente instancia del algoritmo para calcular el puntaje del equipo se corre con el agente conflictivo en su posición \textbf{original}, y continuando con la posición hipotética del siguiente agente, hasta haber evaluado todas las acciones correspondientes a intenciones mejor priorizadas que la propia.

El algoritmo finaliza al momento de analizar la acción propia; el agente procede exactamente de la misma manera que cuando analiza acciones de sus compañeros, y si su acción representa un conflicto con alguno de los miembros del equipo mejor priorizados, el agente pasa inmediatamente a actuar en \textit{modo seguro}. En caso contrario, el agente se ha asegurado de que su acción no perjudicará a los compañeros con intenciones mejor priorizadas, y por lo tanto mantiene la decisión tomada en la fase de Planning, y la ejecuta.

\subsection{Resolución de conflictos}

A continuación proponemos un método para resolver los conflictos detectados por el sistema, así como algunas alternativas de acción en trabajos a futuro.

\subsubsection{Acciones seguras}

En caso de que el un agente detecte que su acción a realizar es perjudicial para el equipo, el diseño actual distribuido hace que el agente tenga la responsabilidad de actuar en \textit{modo seguro}. Este modo de actuar implica realizar acciones que puedan beneficiar de alguna manera al equipo, pero sin correr riesgo de pérdida de puntaje global; es decir, el agente realiza cualquier acción \textit{que no implique movimiento} y suponga algún tipo de mejora respecto a no realizar ninguna acción. Un ejemplo válido de acción segura para todos los roles de agente es la acción \textit{recharge}; por lo tanto, si el movimiento de un agente puede causar pérdida mayor de puntos, éste puede limitarse a recuperar su energía y buscar otra acción útil el turno siguiente. La acción \textit{survey} también resulta extremadamente útil en esta situación, dado que proveerá información del mapa a todos los demás agentes en el turno siguiente gracias al Servidor de Percepciones. Por último, el impedimento para desplazarse convierte al turno en una excelente oportunidad para que los agentes realicen la acción \textit{buy} para mejorar sus características físicas, en caso de que el equipo tenga créditos suficientes.

Considerando, además, los roles de los agentes, podemos definir otras acciones \textit{seguras}: los exploradores pueden realizar la acción \textit{probe} sobre el nodo en el que se encuentran parados sin ningún tipo de riesgo, aportando además información valiosa sobre el mapa a sus compañeros. Los saboteadores tienen la posibilidad de atacar enemigos cercanos sin moverse, convirtiéndola también en una acción \textit{segura}. Los inspectores pueden realizar la acción \textit{inspect} sobre cualquier enemigo cercano, los reparadores pueden ayudar a sus compañeros a recuperar su salud sin desplazarse, y por último, los reparadores, saboteadores y sentinelas pueden realizar \textit{parry} para intentar prevenir ataques enemigos.

Si bien probablemente ninguna de las acciones alternativas resulte óptima en vista del estado del escenario, se ha comprobado empíricamente luego de diez mil simulaciones de trescientos cincuenta turnos cada una, que el cambio a \textit{modo seguro} de los agentes resulta extremadamente beneficioso para el puntaje del equipo.% esto quizás se pueda poner en las conclusiones!
