\chapter{Sistema de resolución de conflictos}
En este capítulo se propondrá el marco teórico y el esquema aplicativo del sistema de resolución de conflictos a utilizar en el marco de MAPC. Es importante destacar que, si bien por limitaciones temporales nuestro equipo únicamente implementó coordinaciones implícitas entre las acciones de los agentes durante la competencia del año 2011, la idea de implementación de un sistema de coordinación más complejo y robusto fue parte de los planes desde el comienzo del trabajo.

\section{Información necesaria}
Después de estudiar el flujo de información y el contenido de la base de conocimiento de cada uno de nuestros agentes, sabemos que en cada turno un agente conoce su conjunto completo de creencias, deseos, y tiene al menos una intención persistente y bien determinada, al igual que \textit{al menos} una acción a realizar a futuro. Recordemos, además, que gracias al Servidor de Percepciones cada agente tiene una visión unificada del mundo y conoce los roles, posiciones y características físicas de sus compañeros de equipo.

Consideremos el agregado a la arquitectura mostrado; luego de esta nueva fase de comunicación, todos los agentes conocen la decisión tomada por sus compañeros de equipo, incluyendo tanto la intención más fuerte como la acción a realizar por cada uno de ellos.  Toda esta información, en conjunto, puede ser utilizada con el fin de re-analizar concretamente cuán potencialmente beneficiosa, peligrosa o perjudicial es la acción a realizar por el agente, y reconsiderar al respecto.

\section{Propuesta de coordinación}

Mostraremos ahora la primer posibilidad de coordinación propuesta; este sistema fue propuesto para ser utilizado durante la competencia MAPC 2011, y si bien no pudo ser presentado por falta de tiempo, existen algunas versiones en estado \textit{beta} ya implementadas.

Dado que el sistema provee suficiente flexibilidad como para permitir definir
distintas estrategias de resolución de acuerdo a la táctica utilizada en la fase
actual del juego, el primer paso es escribir diferentes órdenes de prioridad
acordes a dichas fases. Es decir, el sistema de resolución propuesto permite
modificar el comportamiento de los agentes de manera dinámica según el estado
del juego, en lugar de resolver los potenciales conflictos siempre del mismo
modo. Los órdenes de prioridad escritos pueden determinar, por ejemplo, tanto qué tipo de acciones tendrán predominancia sobre otras, como qué roles de agentes actuarán primero en caso de conflicto.

Una vez que contamos con los órdenes de prioridad, el agente utiliza todo el
conocimiento de las características físicas y las intenciones y acciones
inminentes de sus compañeros, y re-evalúa la propia. Es importante mencionar
que, en este esquema de coordinación, cuando un agente decide que realizar la
acción que había elegido deja de ser conveniente, pasa a actuar de manera
\textit{segura}, en el sentido de que realiza acciones que garantizan (o al
menos, maximizan las chances de) que no haya conflictos con otros agentes o
riesgo de pérdida de puntos. Se detallarán las potenciales acciones a realizar en \textit{modo seguro} en la sección siguiente, y más adelante analizaremos alternativas de acción que puedan dar aún más rédito.

\subsection{Clasificación de conflictos}
Existen diferentes tipos de conflicto que los agentes pueden encontrar al
momento de reconsiderar su decisión respecto a la manera de actuar.

Resulta natural pensar, por ejemplo, que si dos o más agentes van a realizar una acción persiguiendo
una intención idéntica (y que dicha acción/intención deba ser
realizada una única vez), entonces es un malgasto de recursos (energía) que
todos ellos la realicen. Un ejemplo de este caso ocurre cuando dos agentes
cualesquiera tienen como intención survey($X_{i}$), cuando dos exploradores
tienen como intención probear($X_{i}$), o cuando dos inspectores tienen como
intención inspect($X_{i}$), para el mismo \textit{i}. En cualquiera de estos
casos, resulta evidente que sólo uno de los agentes debería llevar a cabo la
acción. El criterio específico para decidir cuál de ellos la realiza puede ser
definido de muchas maneras; el propuesto para la competencia fue dejar que el
agente que pudiera efectivizar la intención en menor cantidad de turnos
realizara la acción, y en caso de empate, dejar que el que tuviera más energía
fuera el ganador. Si ambas condiciones resultaran en empate, el ganador se
determina por orden lexicográfico, pasando todos los perdedores a actuar en \textit{modo seguro}.

Sin embargo, no todos los casos en los que dos o más agentes tengan exactamente
la misma intención resultan conflictivos: por ejemplo, dos saboteadores pueden
querer atacar de manera simultánea a un mismo enemigo. Esta situación da lugar a
la clasificación de todas las intenciones en dos tipos: \textit{cooperativas} y
\textit{excluyentes}.

Por último, existen conflictos más complejos para su detección y
resolución; por ejemplo, que dos agentes decidan moverse para
expandir una zona ya dominada, y que el movimiento sincronizado resulte en la
pérdida de la zona.

A continuación, analizaremos cómo se detectan y resuelven todos estos
conflictos.

\subsection{Detección de conflictos}

Una vez finalizada la segunda fase de comunicación, cada agente considera las
intenciones y acciones a realizar de los demás miembros del equipo en busca de
potenciales conflictos.

El primer paso consiste en ordenar las acciones inminentes a realizar de cada uno de los agentes de acuerdo al orden de prioridad establecido para la fase del juego actual.%bla bla bla bla bla

El paso siguiente es verificar si otros agentes tienen una
intención \textit{excluyente} que coincida con la propia. Si ese es el caso, se
evalúa cuál de dichos agentes se encuentra en mejor estado para efectivizar
la intención (de acuerdo a, como se mencionó antes, la cantidad de turnos
que necesitará para efectivizarla, seguido en caso de empate por la energía de cada uno de ellos, y por último según el orden lexicográfico de sus nombres).
Por razones de optimización, en las versiones beta ya implementadas del sistema los agentes proveen en la última fase de comunicación la cantidad de turnos que suponen necesitar para efectivizar la intención (considerando siempre el mejor caso; es decir, que no ocurran condiciones de corte, ataques enemigos, o cambios de plan repentinos).% mencionar que en versiones futuras se puede incluir TODO EL PLAN de los agentes (es decir, todos los pasos que van a seguir), para posiblemente argumentar sobre la mejor decisión con eso (?)

A continuación, en caso de que la etapa anterior no haya detectado ningún conflicto, se pasa a la fase más compleja de la detección; dado que cada agente que provoque cambios en su posición en el mapa puede afectar el control de las zonas dominadas, el sistema realiza una simulación progresiva de los puntos que el equipo puede obtener de acuerdo a las nuevas hipotéticas posiciones de cada agente. Esta simulación es llamada \textit{progresiva} porque se realiza corriendo una instancia del algoritmo de coloreo por cada nueva posición hipotética de los agentes, ordenadas según el orden de prioridad establecido. El sistema comienza calculando el puntaje según las posiciones originales de todos los agentes excepto el que tiene la mayor prioridad para moverse; a partir de este puntaje base, se vuelve a correr el algoritmo de coloreo con la nueva posición hipotética del segundo agente mejor priorizado; este puntaje se compara con el puntaje base del primer cálculo,% mayor o igual? definir threshold?
y si es mayor o igual, pasa a ser el nuevo puntaje de referencia. Los cálculos continúan repitiéndose posicionando a cada agente en su nueva posición hipotética (si efectivamente mejora o mantiene igual los puntos obtenidos en cada turno), o dejándolos en su posición original y continuándo el análisis para el resto (en caso de que se haya detectado que su movimiento decrementa los puntos obtenidos, y se considere que el agente pasa a actuar en \textit{modo seguro}), hasta haber analizado las acciones de todos los agentes.

\subsection{Resolución de conflictos}